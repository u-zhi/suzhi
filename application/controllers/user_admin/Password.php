<?php/** * User: Allen * Date: 16-07-12 * 密码控制器 * ━━━━━━神兽出没━━━━━━ * 　　　┏┓　　　┏┓ * 　　┏┛┻━━━┛┻┓ * 　　┃　　　　　　　┃ * 　　┃　　　━　　　┃ * 　　┃　┳┛　┗┳　┃ * 　　┃　　　　　　　┃ * 　　┃　　　┻　　　┃ * 　　┃　　　　　　　┃ * 　　┗━┓　　　┏━┛Code is far away from bug with the animal protecting * 　　　　┃　　　┃    神兽保佑,代码无bug * 　　　　┃　　　┃ * 　　　　┃　　　┗━━━┓ * 　　　　┃　　　　　　　┣┓ * 　　　　┃　　　　　　　┏┛ * 　　　　┗┓┓┏━┳┓┏┛ * 　　　　　┃┫┫　┃┫┫ * 　　　　　┗┻┛　┗┻┛ * * ━━━━━━感觉萌萌哒━━━━━━ */class Password extends PC_Controller {	function __construct() {		parent::__construct();		$this->load->model('admin_model');		$this->load->helper('hash_helper');	}	/**	 * @brief	修改密码	 * @param 	Null	 * @author	Allen	 * @since	2016/07/12 Ver 1.0	 */	function index() {		$this->data['user_info'] = $this->session->userdata('ALLEN_WANG');		$this->load->view('/admin/password', $this->data);	}	 	/**	 * @brief	检查密码是否正确	 * @param 	Null	 * @author	Allen	 * @since	2016/07/12 Ver 1.0	 */	function check_password() {		$data = $_POST;		//extract($data);		$where['id'] = $data['id'];		if ($this->_check_password($data['id'], $data['oldpass'])) {			$datainfo['msg'] = 1; //检测成功					} else {			$datainfo['msg'] = 2; //检测失败					}		echo json_encode($datainfo);	}		function _check_password($id, $password) {		$where['id'] = $id;		$result = $this->admin_model->checkAdmin($where);		return $result && passwd_verify($password, $result['password']);	}		/**	 * @brief	保存新密码	 * @param 	Null	 * @author	Allen	 * @since	2016/07/12 Ver 1.0	 */	function edit_password() {		$data = $_POST;		$result = null;		// 编辑密码之前仍然需要检查密码正确性		if ($this->_check_password($data['id'], $data['oldpass'])) {			$data['password'] = passwd_hash($data['newpass']);			unset($data['newpass']);unset($data['oldpass']);			$where['id'] = $data['id'];			$result = $this->admin_model->editAdmin($where, $data);		}		if ($result) {			$datainfo['msg'] = 1; //更改成功					} else {			$datainfo['msg'] = 2; //连接数据库失败					}		echo json_encode($datainfo);	}		/**	 * @brief	登出操作（清空session）	 * @param 	Null	 * @author	Allen	 * @since	2016/07/12 Ver 1.0	 */	function logout() {		$this->session->unset_userdata('user_id');		$this->session->unset_userdata('user_name');		session_unset();		header("Location:" . base_url() . "index.php/login");	}}